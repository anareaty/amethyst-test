{{ $content := .Content }}
{{ $raw := .RawContent }}
{{ $page := .Page }}


{{/* List callouts */}}
  
{{ $content = $content | replaceRE "<li>NB " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg> ` }}

{{ $content = $content | replaceRE "<li>WR " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-tool"><path d="M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z"/><path d="m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18"/><path d="m2.3 2.3 7.286 7.286"/><circle cx="11" cy="11" r="2"/></svg> ` }}

{{ $content = $content | replaceRE "<li>! " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> ` }}

{{ $content = $content | replaceRE "<li>\\? " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg> ` }}

{{ $content = $content | replaceRE "<li>&amp; " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lightbulb idea"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg> ` }}





{{ $content = $content | replaceRE "<li>% " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lightbulb idea-done"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg> ` }}

{{ $content = $content | replaceRE "<li>\\$ " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg> ` }}

{{ $content = $content | replaceRE "<li>@ " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloudy"><path d="M17.5 21H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/><path d="M22 10a3 3 0 0 0-3-3h-2.207a5.502 5.502 0 0 0-10.702.5"/></svg> ` }}

{{ $content = $content | replaceRE "<li>~ " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg> ` }}

{{ $content = $content | replaceRE "<li>TBR " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-marked"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><polyline points="10 2 10 10 13 7 16 10 16 2"/></svg> ` }}

{{ $content = $content | replaceRE "<li>RE " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg> ` }}

{{ $content = $content | replaceRE "<li>BUG " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bug"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg> ` }}

{{ $content = $content | replaceRE "<li>DONE " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-check"><path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L13 16"/></svg> ` }}

{{ $content = $content | replaceRE "<li>VID " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-film video"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg> ` }}

{{ $content = $content | replaceRE "<li>NEW " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/></svg> ` }}

{{ $content = $content | replaceRE "<li>STAR " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> ` }}

{{ $content = $content | replaceRE "<li>MOV " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-film movie"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg> ` }}

{{ $content = $content | replaceRE "<li>URL " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> ` }}

{{ $content = $content | replaceRE "<li>EV " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coffee"><path d="M10 2v2"/><path d="M14 2v2"/><path d="M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"/><path d="M6 2v2"/></svg> ` }}

{{ $content = $content | replaceRE "<li>QU " `<li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-quote"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg> ` }}





{{/* Escape slashes for Latex to fix line breaks */}}
{{$latex := findRE "(?:\\${2}([^\\$]+)\\${2})|(?:\\$([^\\$]*)\\$)" $content}}
{{range $latex}}
  {{$fixed := replaceRE "\\\\(?: +|\\n)" "\\\\ " .}}
  {{$content = replace $content . $fixed}}
{{end}}

{{/* Wikilinks */}}
{{$wikilinks := $content | findRE "!?\\[\\[\\S[^\\[\\]\\|]*(?:\\|[^\\[\\]]*)?\\S\\]\\]" }}
{{$codefences := $raw | findRE "\\x60[^\\x60\\n]+\\x60"}}
{{$codeblocks := $raw | findRE "\\x60{3}[^\\x60]+\\x60{3}"}}
{{$code := union $codefences $codeblocks}}

{{range $wikilinks}}
  {{$cur := .}}
  {{$incode := false}}
  {{range $code}}
    {{if (in . $cur)}}
      {{$incode = true}}
    {{end}}
  {{end}}

  {{if not $incode}}

    <!-- remove link delimiters -->
    {{$inner := . | strings.TrimPrefix "!" | strings.TrimPrefix "[[" | strings.TrimSuffix "]]" }}
    <!-- split from alias -->
    {{$split := split $inner "|"}}
    <!-- separate link path -->
    {{$path := index $split 0}}

    {{$reference := split $path "#"}}
    <!-- path with heading link removed -->
    {{$title := index $reference 0}}
    <!-- $display is hyperlink display text -->
    <!-- use alias, else title -->
    {{$display := default $title (index $split 1)}}
    <!-- remove subfolder from title -->
    {{$display := index (last 1 (split $display "/")) 0}}

    <!-- attempt to get title -->
    {{$searchtitle := $title }}
    {{$curpage := $page.GetPage $searchtitle }}
    <!-- attempt to search md file instead  -->
    {{ if (eq $curpage.String "nopPage") }}
      {{$searchtitle = (add $title ".md") }}
      {{$curpage = $page.GetPage $searchtitle }}
    {{ end }}
    <!-- attempt to reverse typographer behaviour  -->
    {{ if (eq $curpage.String "nopPage") }}
      {{$searchtitle = (replace $searchtitle "&amp;" "&") }}
      {{$searchtitle = (replace $searchtitle "&quot;" "\"") }}
      {{$searchtitle = (replace $searchtitle "&rdquo;" "\"") }}
      {{$searchtitle = (replace $searchtitle "&ldquo;" "\"") }}
      {{$searchtitle = (replace $searchtitle "&rsquo;" "'") }}
      {{$searchtitle = (replace $searchtitle "&lsquo;" "'") }}
      {{$curpage = $page.GetPage $searchtitle }}
    {{ end }}
    {{$relpath := relURL $path}}

    <!-- If path to Hugo page -->
    {{if not (eq $curpage.String "nopPage") }}
      {{$block := default "" (index $reference 1)}}
      {{$block = strings.TrimRight "/" (cond (eq $block "") $block (printf "#%s" $block)) | urlize | lower}}
      {{$href := strings.TrimRight "/" $curpage.RelPermalink}}




      
      {{ $linkFileId := $curpage.File.UniqueID }}


      {{$link := printf "<a id=\"link-%s\" href=\"%s%s\" rel=\"noopener\" class=\"internal-link\" data-src=\"%s\">%s</a>" $linkFileId $href $block $href $display}}
    





      {{$content = replace $content . $link}}
    {{/* $content = printf "%s%s" $content $popover */}}



    <!-- If path to existing file -->
    <!-- else if fileExists $relpath -->

    {{else}}
      {{$splitpath := split $relpath "/"}}
      {{$dirname := first (sub (len $splitpath) 1) $splitpath | path.Join | urlize}}
      {{$basename := index (last 1 $splitpath) 0}}
      {{$href := printf "/%s/%s" $dirname $basename}}



  

      <!-- Embedded? -->
      {{if (hasPrefix . "!")}}
        {{$width := index $split 1}}
        {{$link := printf "<img src=\"%s\" width=\"%s\" />" $href (default "auto" $width)}}
        {{$content = replace $content . $link}}
      {{else}}
        {{$link := printf "<a href=\"%s\" rel=\"noopener\" class=\"internal-link\">%s</a>" $href $display}}
        {{$content = replace $content . $link}}
      {{end}}
    {{end}}
  {{end}}
{{end}}

{{/* Add jumpable anchors */}}
{{ $content = $content | replaceRE "(<h[1-9] id=\"([^\"]+)\">)(.+)(</h[1-9]>)" `<a href="#${2}">${1}<span class="hanchor" ariaLabel="Anchor"># </span>${3}${4}</a>` }}

{{/* Callouts */}}
{{if $.Site.Params.enableCallouts}}
  {{ $content = $content | replaceRE "<blockquote>" "<blockquote class=callout>" }}
  {{ $blockquoteclasses := findRE `\[!.+\]` $content }}
  {{ $blockquoteclasses1 := findRE "<blockquote.*?>(.|\n)*?</blockquote>" $content }}
  {{ $blockquotetags := findRE `blockquote class=callout` $content }}
  {{ $counter := 0 }}
  {{ $counter1 := 0 }}
  {{ $finder := index $blockquoteclasses1 $counter }}
  {{range $blockquotetags}}
    {{ $finder = index $blockquoteclasses1 $counter }}
    {{ if (in $finder "[!") }}
      {{ $inner := index $blockquoteclasses $counter1 }}
      {{ if (in $finder "]-") }}
        {{ $inner = $inner | replaceRE `\[!([a-zA-Z-]+)\]` `callout-collapsible callout-collapsed ${1}`}}
      {{ else if (in $finder "]+") }}
        {{ $inner = $inner | replaceRE `\[!([a-zA-Z-]+)\]` `callout-collapsible ${1}`}}
      {{ else}}
        {{ $inner = $inner | replaceRE `\[!([a-zA-Z-]+)\]` `${1}` }}
      {{ end }}
      {{ $inner = printf "blockquote class=\"%s-callout callout\"" $inner | lower}}
      {{ $content = replace $content . $inner 1}}
      {{ $counter1 = add $counter1 1 }}
    {{ else }}
      {{ $inner := print "blockquote" }}
      {{ $content = replace $content . $inner 1}}
    {{ end }}
    {{ $counter = add $counter 1 }}
  {{end}}
  {{ $content = $content | replaceRE `\[![a-zA-Z-]+\][-\+]?` "" }}
  {{ $content = $content | replaceRE "blockquote class=callout" "blockquote" }}
{{end}}

{{/* Make ==text== into <mark>text</mark> */}}
{{$mark := findRE "==([^=\n]+)==" $content}}
{{range $mark}}
  {{$fixed := printf "<mark>%s</mark>" (replace . "==" "")}}
  {{$content = replace $content . $fixed}}
{{end}}





{{/* Checkboxes */}}

{{ $content = $content | replaceRE `<input disabled="" type="checkbox">` `<input disabled="" type="checkbox" data-task=" ">` }}
{{ $content = $content | replaceRE `<input checked="" disabled="" type="checkbox">` `<input checked="" disabled="" type="checkbox" data-task="x">` }}
{{ $content = $content | replaceRE "<li>\\[(.)\\]" `<li><input checked="" disabled="" type="checkbox" data-task="${1}">` }}







{{ $content = $content | replaceRE "href=\"\"" "href=\"/\"" }}

{{ $content = $content | replaceRE "(href=)([^ ]*)(\\/_index)" "${1}${2}/" }}

  

{{ $content | safeHTML }}


  


